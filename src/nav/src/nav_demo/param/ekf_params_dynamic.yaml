# =================================================
# Robot Localization EKF 参数配置 (基于 OUC 定制版)
# =================================================

frequency: 50.0            # 30Hz 对于移动机器人足够了，太高消耗CPU
sensor_timeout: 0.1
two_d_mode: true           # 【关键】强制 2D 模式，彻底解决 Z 轴乱飞问题
transform_time_offset: 0.0
transform_timeout: 0.0
print_diagnostics: true
debug: false

map_frame: map
odom_frame: odom
base_link_frame: base_link
world_frame: odom
use_sim_time: false

# =================================================
# 输入源 1: ZED 相机 (提供绝对位置)
# =================================================
odom0: /zed2i/zed_node/odom
# 配置: 只使用 X, Y。忽略 Z 和所有角度、速度。
odom0_config: [true,  true,  false,
               false, false, true,
               false, false, false,
               false, false, true,
               false, false, false]
# 【策略】关掉微分，把 ZED 当作 GPS 用。让它负责纠正长期漂移。
odom0_differential: false
odom0_relative: true
odom0_queue_size: 10
odom0_nodelay: false 

# =================================================
# 输入源 2: rf2o 激光雷达 (提供高精度局部移动)
# =================================================
odom1: /lidar_odom
# 配置: 使用 X, Y, Yaw。
odom1_config: [true,  true,  false,
               false, false, false,
               true, false, false,
               false, false, true,
               false, false, false]
# 【策略】开启微分！这会把 rf2o 的位置变成“速度”融合。
# 这样既利用了 rf2o 的高精度，又不会因为坐标原点不同而和 ZED 打架。
odom1_differential: false
odom1_relative: true
odom1_queue_size: 10
odom1_nodelay: false

# =================================================
# 输入源 3: IMU (提供姿态和加速度)
# =================================================
# imu0: /zed2i/zed_node/imu/data
# imu0_config: [false, false, false,
#               false,  false,  false,  # Roll, Pitch, Yaw
#               false, false, false,
#               false, false, false,
#               true,  false,  false]  # Accel
# imu0_differential: false
# imu0_relative: true           # 【建议】IMU 相对模式设为 true，消除启动时的磁力计/重力偏差
# imu0_remove_gravitational_acceleration: true
# #基于你的ZED2i输出的协方差配置（推荐，最准确）
# imu0_covariance: [
#   0.015510192140936852, 0.0, 0.0, 0.0, 0.0, 0.0,    # ax方差
#   0.0, 0.007005379535257816, 0.0, 0.0, 0.0, 0.0,    # ay方差
#   0.0, 0.0, 0.010876546613872051, 0.0, 0.0, 0.0,    # az方差
#   0.0, 0.0, 0.0, 8.654703511972608e-10, 0.0, 0.0,   # gx方差
#   0.0, 0.0, 0.0, 0.0, 7.631423465477385e-10, 0.0,   # gy方差
#   0.0, 0.0, 0.0, 0.0, 0.0, 5.785804861468702e-10    # gz方差
# ]

# imu1: /imu0
# imu1_config: [false, false, false,
#               false,  false,  false,  # Roll, Pitch, Yaw
#               false, false, false,
#               false, false, false,
#               true,  false,  false]  # Accel
# imu1_differential: false
# imu1_relative: true           # 【建议】IMU 相对模式设为 true，消除启动时的磁力计/重力偏差
# imu1_remove_gravitational_acceleration: true
# imu1_covariance: [
#   3.57143e-07, 0.0, 0.0, 0.0, 0.0, 0.0,
#   0.0, 8.20870e-07, 0.0, 0.0, 0.0, 0.0,
#   0.0, 0.0, 1.02486e-06, 0.0, 0.0, 0.0,
#   0.0, 0.0, 0.0, 1.24208e-09, 0.0, 0.0,
#   0.0, 0.0, 0.0, 0.0, 8.72082e-10, 0.0,
#   0.0, 0.0, 0.0, 0.0, 0.0, 1.74205e-09
# ]
# =================================================
# 过程噪声协方差 (Process Noise) - 核心调参区
# =================================================
# 这里的数值必须足够大，EKF 才会允许 ZED 修改位置。
# 既然 ZED 是 1e-3，这里我们也设在 1e-3 到 1e-4 之间。
process_noise_covariance: [
  0.05, 0,    0,    0,    0,    0,    0,     0,     0,    0,    0,    0,    0,    0,    0,  # x (加大，允许ZED纠偏)
  0,    0.05, 0,    0,    0,    0,    0,     0,     0,    0,    0,    0,    0,    0,    0,  # y (加大，允许ZED纠偏)
  0,    0,    0.01, 0,    0,    0,    0,     0,     0,    0,    0,    0,    0,    0,    0,  # z
  0,    0,    0,    0.01, 0,    0,    0,     0,     0,    0,    0,    0,    0,    0,    0,  # roll
  0,    0,    0,    0,    0.01, 0,    0,     0,     0,    0,    0,    0,    0,    0,    0,  # pitch
  0,    0,    0,    0,    0,    0.02, 0,     0,     0,    0,    0,    0,    0,    0,    0,  # yaw
  0,    0,    0,    0,    0,    0,    0.01,  0,     0,    0,    0,    0,    0,    0,    0,  # vx
  0,    0,    0,    0,    0,    0,    0,     0.01,  0,    0,    0,    0,    0,    0,    0,  # vy
  0,    0,    0,    0,    0,    0,    0,     0,     0.01, 0,    0,    0,    0,    0,    0,  # vz
  0,    0,    0,    0,    0,    0,    0,     0,     0,    0.01, 0,    0,    0,    0,    0,  # vroll
  0,    0,    0,    0,    0,    0,    0,     0,     0,    0,    0.01, 0,    0,    0,    0,  # vpitch
  0,    0,    0,    0,    0,    0,    0,     0,     0,    0,    0,    0.02, 0,    0,    0,  # vyaw
  0,    0,    0,    0,    0,    0,    0,     0,     0,    0,    0,    0,    0.01, 0,    0,  # ax
  0,    0,    0,    0,    0,    0,    0,     0,     0,    0,    0,    0,    0,    0.01, 0,  # ay
  0,    0,    0,    0,    0,    0,    0,     0,     0,    0,    0,    0,    0,    0,    0.01] # az

# 初始协方差 (保持不动)
initial_estimate_covariance: [
  1e-9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 1e-9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 1e-9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 1e-9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 1e-9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 1e-9, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 1e-9, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1e-9, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 1e-9, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 1e-9, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1e-9, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1e-9, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1e-9, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1e-9, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1e-9]
